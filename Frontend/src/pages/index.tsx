import { useState, useEffect } from 'react';
import AdvisoryCard from '@/components/AdvisoryCard';
import FiltersSection, { type FilterState } from '@/components/FiltersSection';
import { fetchAdvisory, type AdvisoryResponse } from '@/lib/api';
import { Button } from "@/components/ui/button";

const translations = {
  hi: {
    title: "Kheti Vani - Voice of the Farm",
    subtitle: "рдЖрдкрдХреА рдЦреЗрддреА рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ рдорд╛рд░реНрдЧрджрд░реНрд╢рди",
    dashboard: "рдбреИрд╢рдмреЛрд░реНрдб",
    prediction: "рдлрд╕рд▓ рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рди",
    weather: "рдореМрд╕рдо рдЕрдкрдбреЗрдЯ",
    soil: "рдорд┐рдЯреНрдЯреА рд╕реНрд╡рд╛рд╕реНрдереНрдп",
    market: "рдмрд╛рдЬрд╛рд░ рднрд╛рд╡",
    expectedYield: "рдЕрдкреЗрдХреНрд╖рд┐рдд рдЙрддреНрдкрд╛рджрди",
    soilMoisture: "рдорд┐рдЯреНрдЯреА рдХреА рдирдореА",
    todayWeather: "рдЖрдЬ рдХрд╛ рдореМрд╕рдо",
    wheatPrice: "рдЧреЗрд╣реВрдВ рднрд╛рд╡",
    aiPrediction: "AI-Powered рдлрд╕рд▓ рдкреВрд░реНрд╡рд╛рдиреБрдорд╛рди",
    aiDescription: "рдЕрдкрдиреА рдлрд╕рд▓ рдХреА рдЙрддреНрдкрд╛рджрдХрддрд╛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП AI рд╕реБрдЭрд╛рд╡ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ",
    getAI: "AI рд╕реБрдЭрд╛рд╡ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ",
    uploadPhoto: "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдХрд░реЗрдВ",
    filterSearch: "рдлрд┐рд▓реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдЦреЛрдЬреЗрдВ",
    weatherDetails: "рдореМрд╕рдо рд╡рд┐рд╡рд░рдг",
    soilHealthDetails: "рдорд┐рдЯреНрдЯреА рд╕реНрд╡рд╛рд╕реНрдереНрдп",
    marketRates: "рдЖрдЬ рдХреЗ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡",
    temperature: "рддрд╛рдкрдорд╛рди",
    humidity: "рдирдореА",
    rainfall: "рд╡рд░реНрд╖рд╛",
    phLevel: "pH рд╕реНрддрд░",
    nitrogen: "рдирд╛рдЗрдЯреНрд░реЛрдЬрди",
    phosphorus: "рдлрд╛рд╕реНрдлреЛрд░рд╕",
    bestPlantingTime: "рдмреБрд╡рд╛рдИ рдХрд╛ рд╕рдордп",
    irrigationSchedule: "рд╕рд┐рдВрдЪрд╛рдИ рд╢реЗрдбреНрдпреВрд▓",
    aiSuggestions: "AI рд╕реБрдЭрд╛рд╡",
    increase: "рд╡реГрджреНрдзрд┐",
    decrease: "рдХрдореА",
    stable: "рд╕реНрдерд┐рд░",
    comparedToLastYear: "рдкрд┐рдЫрд▓реЗ рд╕рд╛рд▓ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ",
    idealLevel: "рдЖрджрд░реНрд╢ рд╕реНрддрд░",
    todayMarketRate: "рдЖрдЬ рдХреЗ рдмрд╛рдЬрд╛рд░ рднрд╛рд╡",
    weatherCondition: "рдореМрд╕рдо рдХреА рд╕реНрдерд┐рддрд┐",
    withinNormalRange: "рд╕рд╛рдорд╛рдиреНрдп рд░реЗрдВрдЬ рдореЗрдВ",
    soilImprovementSuggestions: "ЁЯМ▒ рдорд┐рдЯреНрдЯреА рд╕реБрдзрд╛рд░ рдХреЗ рд╕реБрдЭрд╛рд╡:",
    addDAPFertilizer: "рдлрд╛рд╕реНрдлреЛрд░рд╕ рдХреА рдХрдореА рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП DAP рдЦрд╛рдж рдбрд╛рд▓реЗрдВ",
    improveWithOrganic: "рдЬреИрд╡рд┐рдХ рдЦрд╛рдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд┐рдЯреНрдЯреА рдХреА рдЧреБрдгрд╡рддреНрддрд╛ рдмрдврд╝рд╛рдПрдВ",
    useMulching: "рдорд┐рдЯреНрдЯреА рдХреА рдирдореА рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП mulching рдХрд░реЗрдВ",
    marketTrends: "ЁЯУИ рдмрд╛рдЬрд╛рд░ рдЯреНрд░реЗрдВрдбреНрд╕:",
    oilseedDemand: "тАв рддрд┐рд▓рд╣рдиреА рдлрд╕рд▓реЛрдВ (рд╕реЛрдпрд╛рдмреАрди, рд╕рд░рд╕реЛрдВ) рдХреА рдорд╛рдВрдЧ рдмрдврд╝ рд░рд╣реА рд╣реИ",
    wheatStable: "тАв рдЧреЗрд╣реВрдВ рдХреЗ рджрд╛рдо рд╕реНрдерд┐рд░ рд░рд╣рдиреЗ рдХреА рдЙрдореНрдореАрдж",
    cottonVolatile: "тАв рдХрдкрд╛рд╕ рдХреА рдХреАрдорддреЛрдВ рдореЗрдВ рдЕрд╕реНрдерд┐рд░рддрд╛ рдЬрд╛рд░реА",
    fromLastWeek: "рдкрд┐рдЫрд▓реЗ рд╕рдкреНрддрд╛рд╣ рд╕реЗ",
    loadingAdvice: "рдХреГрд╖рд┐ рд╕рд▓рд╛рд╣ рд▓реЛрдб рдХрд░ рд░рд╣реЗ рд╣реИрдВ...",
    loadingData: "рдбреЗрдЯрд╛ рд▓реЛрдб рдХрд░ рд░рд╣реЗ рд╣реИрдВ...",
    quintal: "рдХреНрд╡рд┐рдВрдЯрд▓",
    pleaseSelectFilters: "рдХреГрдкрдпрд╛ AI рд╕реБрдЭрд╛рд╡ рдкрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдлрд┐рд▓реНрдЯрд░ рдЪреБрдиреЗрдВ",
    wheat: "рдЧреЗрд╣реВрдВ",
    rice: "рдзрд╛рди", 
    sugarcane: "рдЧрдиреНрдирд╛",
    maize: "рдордХреНрдХрд╛",
    soybean: "рд╕реЛрдпрд╛рдмреАрди",
    cotton: "рдХрдкрд╛рд╕",
    pulses: "рджрд╛рд▓",
    potato: "рдЖрд▓реВ",
    onion: "рдкреНрдпрд╛рдЬ"
  },
  en: {
    title: "Kheti Vani - Voice of the Farm",
    subtitle: "Expert guidance for your farming",
    dashboard: "Dashboard",
    prediction: "Crop Prediction",
    weather: "Weather Update",
    soil: "Soil Health",
    market: "Market Rates",
    expectedYield: "Expected Yield",
    soilMoisture: "Soil Moisture",
    todayWeather: "Today's Weather",
    wheatPrice: "Wheat Price",
    aiPrediction: "AI-Powered Crop Prediction",
    aiDescription: "Get AI recommendations to increase your crop productivity",
    getAI: "Get AI Suggestions",
    uploadPhoto: "Upload Photo",
    filterSearch: "Search by Filters",
    weatherDetails: "Weather Details",
    soilHealthDetails: "Soil Health Details",
    marketRates: "Today's Market Rates",
    temperature: "Temperature",
    humidity: "Humidity",
    rainfall: "Rainfall",
    phLevel: "pH Level",
    nitrogen: "Nitrogen",
    phosphorus: "Phosphorus",
    bestPlantingTime: "Best Planting Time",
    irrigationSchedule: "Irrigation Schedule",
    aiSuggestions: "AI Suggestions",
    increase: "Increase",
    decrease: "Decrease",
    stable: "Stable",
    comparedToLastYear: "Compared to last year",
    idealLevel: "Ideal level",
    todayMarketRate: "Today's market rate",
    weatherCondition: "Weather Condition",
    withinNormalRange: "Within normal range",
    soilImprovementSuggestions: "ЁЯМ▒ Soil Improvement Suggestions:",
    addDAPFertilizer: "Add DAP fertilizer to address phosphorus deficiency",
    improveWithOrganic: "Improve soil quality using organic manure",
    useMulching: "Use mulching to maintain soil moisture",
    marketTrends: "ЁЯУИ Market Trends:",
    oilseedDemand: "тАв Demand for oilseed crops (soybean, mustard) is increasing",
    wheatStable: "тАв Wheat prices expected to remain stable",
    cottonVolatile: "тАв Cotton price volatility continues",
    fromLastWeek: "From last week",
    loadingAdvice: "Loading agricultural advice...",
    loadingData: "Loading data...",
    quintal: "quintal",
    pleaseSelectFilters: "Please select filters to get AI suggestions",
    wheat: "Wheat",
    rice: "Rice",
    sugarcane: "Sugarcane",
    maize: "Maize",
    soybean: "Soybean",
    cotton: "Cotton",
    pulses: "Pulses",
    potato: "Potato",
    onion: "Onion"
  },
  or: {
    title: "Kheti Vani - Voice of the Farm",
    subtitle: "рмЖрмкрмгрмЩрнНрмХ рмЪрм╛рм╖ рмкрм╛рмЗрмБ рммрм┐рм╢рнЗрм╖рмЬрнНрмЮ рморм╛рм░рнНрмЧрмжрм░рнНрм╢рми",
    dashboard: "рмбрнНрнЯрм╛рм╕рммрнЛрм░рнНрмб",
    prediction: "рмлрм╕рм▓ рмкрнВрм░рнНрммрм╛рмирнБрморм╛рми",
    weather: "рмкрм╛рмгрм┐рмкрм╛рмЧ рмЕрмкрмбрнЗрмЯ",
    soil: "рморм╛рмЯрм┐рм░ рм╕рнНрн▒рм╛рм╕рнНрмернНрнЯ",
    market: "рммрмЬрм╛рм░ рмжрм░",
    expectedYield: "рмЖрм╢рм╛ рмХрм░рм╛рмпрм╛рмЙрмерм┐рммрм╛ рмЙрмдрнНрмкрм╛рмжрми",
    soilMoisture: "рморм╛рмЯрм┐рм░ рмЖрм░рнНрмжрнНрм░рмдрм╛",
    todayWeather: "рмЖрмЬрм┐рм░ рмкрм╛рмгрм┐рмкрм╛рмЧ",
    wheatPrice: "рмЧрм╣рмо рмжрм░",
    aiPrediction: "AI-Powered рмлрм╕рм▓ рмкрнВрм░рнНрммрм╛рмирнБрморм╛рми",
    aiDescription: "рмЖрмкрмгрмЩрнНрмХ рмлрм╕рм▓рм░ рмЙрмдрнНрмкрм╛рмжрмХрмдрм╛ рммрмврм╝рм╛рмЗрммрм╛ рмкрм╛рмЗрмБ AI рмкрм░рм╛рморм░рнНрм╢ рмкрм╛рмЖрмирнНрмдрнБ",
    getAI: "AI рмкрм░рм╛рморм░рнНрм╢ рмкрм╛рмЖрмирнНрмдрнБ",
    uploadPhoto: "рмлрмЯрнЛ рмЕрмкрм▓рнЛрмб рмХрм░рмирнНрмдрнБ",
    filterSearch: "рмлрм┐рм▓рнНрмЯрм░ рмжрнНрн▒рм╛рм░рм╛ рмЦрнЛрмЬрмирнНрмдрнБ",
    weatherDetails: "рмкрм╛рмгрм┐рмкрм╛рмЧ рммрм┐рммрм░рмгрнА",
    soilHealthDetails: "рморм╛рмЯрм┐рм░ рм╕рнНрн▒рм╛рм╕рнНрмернНрнЯ рммрм┐рммрм░рмгрнА",
    marketRates: "рмЖрмЬрм┐рм░ рммрмЬрм╛рм░ рмжрм░",
    temperature: "рмдрм╛рмкрморм╛рмдрнНрм░рм╛",
    humidity: "рмЖрм░рнНрмжрнНрм░рмдрм╛",
    rainfall: "рммрм░рнНрм╖рм╛",
    phLevel: "pH рм╕рнНрмдрм░",
    nitrogen: "рмирм╛рмЗрмЯрнНрм░рнЛрмЬрнЗрми",
    phosphorus: "рмлрм╕рмлрм░рм╕",
    bestPlantingTime: "рммрнБрмгрм┐рммрм╛рм░ рм╕рморнЯ",
    irrigationSchedule: "рмЬрм│рм╕рнЗрмЪрми рмХрм╛рм░рнНрмпрнНрнЯрм╕рнВрмЪрнА",
    aiSuggestions: "AI рмкрм░рм╛рморм░рнНрм╢",
    increase: "рммрнГрмжрнНрмзрм┐",
    decrease: "рм╣рнНрм░рм╛рм╕",
    stable: "рм╕рнНрмерм┐рм░",
    comparedToLastYear: "рмЧрмд рммрм░рнНрм╖ рмдрнБрм│рмирм╛рм░рнЗ",
    idealLevel: "рмЖрмжрм░рнНрм╢ рм╕рнНрмдрм░",
    todayMarketRate: "рмЖрмЬрм┐рм░ рммрмЬрм╛рм░ рмжрм░",
    weatherCondition: "рмкрм╛рмгрм┐рмкрм╛рмЧ рмЕрммрм╕рнНрмерм╛",
    withinNormalRange: "рм╕рм╛рморм╛рмирнНрнЯ рмкрм░рм┐рм╕рм░ рмормзрнНрнЯрм░рнЗ",
    soilImprovementSuggestions: "ЁЯМ▒ рморм╛рмЯрм┐ рмЙрмирнНрмирмдрм┐ рмкрм╛рмЗрмБ рмкрм░рм╛рморм░рнНрм╢:",
    addDAPFertilizer: "рмлрм╕рмлрм░рм╕ рмЕрмнрм╛рмм рмкрнВрм░рмг рмкрм╛рмЗрмБ DAP рм╕рм╛рм░ рмкрнНрм░рнЯрнЛрмЧ рмХрм░рмирнНрмдрнБ",
    improveWithOrganic: "рмЬрнИрммрм┐рмХ рм╕рм╛рм░ рммрнНрнЯрммрм╣рм╛рм░ рмХрм░рм┐ рморм╛рмЯрм┐рм░ рмЧрнБрмгрммрмдрнНрмдрм╛ рммрмврм╝рм╛рмирнНрмдрнБ",
    useMulching: "рморм╛рмЯрм┐рм░ рмЖрм░рнНрмжрнНрм░рмдрм╛ рммрмЬрм╛рнЯ рм░рмЦрм┐рммрм╛ рмкрм╛рмЗрмБ рморм▓рмЪрм┐рмВ рмХрм░рмирнНрмдрнБ",
    marketTrends: "ЁЯУИ рммрмЬрм╛рм░ рмзрм╛рм░рм╛:",
    oilseedDemand: "тАв рмдрнЗрм▓ рммрм┐рм╣рми рмлрм╕рм▓ (рм╕рнЛрнЯрм╛рммрм┐рми, рм╕рм░рм┐рм╖рм╛)рм░ рмЪрм╛рм╣рм┐рмжрм╛ рммрмврм╝рнБрмЫрм┐",
    wheatStable: "тАв рмЧрм╣рмо рмжрм░ рм╕рнНрмерм┐рм░ рм░рм╣рм┐рммрм╛рм░ рмЖрм╢рм╛",
    cottonVolatile: "тАв рмХрмкрм╛ рмжрм░рм░рнЗ рмЕрм╕рнНрмерм┐рм░рмдрм╛ рмЬрм╛рм░рм┐",
    fromLastWeek: "рмЧрмд рм╕рмкрнНрмдрм╛рм╣рм░рнБ",
    loadingAdvice: "рмХрнГрм╖рм┐ рмкрм░рм╛рморм░рнНрм╢ рм▓рнЛрмб рм╣рнЗрмЙрмЫрм┐...",
    loadingData: "рмдрмернНрнЯ рм▓рнЛрмб рм╣рнЗрмЙрмЫрм┐...",
    quintal: "рмХрнНрн▒рм┐рмгрнНрмЯрм╛рм▓",
    pleaseSelectFilters: "AI рмкрм░рм╛рморм░рнНрм╢ рмкрм╛рмЗрммрм╛ рмкрм╛рмЗрмБ рмжрнЯрм╛рмХрм░рм┐ рмлрм┐рм▓рнНрмЯрм░ рммрм╛рмЫрмирнНрмдрнБ",
    wheat: "рмЧрм╣рмо",
    rice: "рмзрм╛рми",
    sugarcane: "рмЖрмЦрнБ", 
    maize: "рмормХрм╛",
    soybean: "рм╕рнЛрнЯрм╛рммрм┐рми",
    cotton: "рмХрмкрм╛",
    pulses: "рмбрм╛рм▓рм┐",
    potato: "рмЖрм│рнБ",
    onion: "рмкрм┐рмЖрмЬ"
  }
};

const icons = {
  wheat: "ЁЯМ╛",
  chartBar: "ЁЯУК", 
  trendingUp: "ЁЯУИ",
  droplets: "ЁЯТз",
  dollarSign: "ЁЯТ░",
  cloud: "тШБя╕П",
  leaf: "ЁЯМ┐",
  camera: "ЁЯУ╖",
  target: "ЁЯОп",
  calendar: "ЁЯУЕ",
  thermometer: "ЁЯМбя╕П",
  eye: "ЁЯСБя╕П"
};

interface DashboardData {
  expectedYield: number;
  yieldTrend: string;
  soilMoisture: number;
  weather: {
    temperature: number;
    humidity: number;
    precipitation: number;
    condition: string;
  };
  marketPrice: number;
  priceTrend: string;
}

const Index = () => {
  const [advisory, setAdvisory] = useState<AdvisoryResponse | null>(null);
  const [isInitialLoading, setIsInitialLoading] = useState(true);
  const [isAILoading, setIsAILoading] = useState(false);
  const [dashboardData, setDashboardData] = useState<DashboardData | null>(null);
  const [soilData, setSoilData] = useState<any>(null);
  const [marketData, setMarketData] = useState<any>(null);
  const [yieldData, setYieldData] = useState<any>(null);
  const [activeSection, setActiveSection] = useState('dashboard');
  const [currentLanguage, setCurrentLanguage] = useState<'hi' | 'en' | 'or'>('hi');

  const t = translations[currentLanguage];

  const getWeatherCondition = (condition: string) => {
    const conditions = {
      'Clear sky': {
        hi: "рд╕рд╛рдл рдЖрд╕рдорд╛рди",
        en: "Clear sky", 
        or: "рмкрм░рм┐рм╖рнНрмХрм╛рм░ рмЖрмХрм╛рм╢"
      },
      'Partly cloudy': {
        hi: "рдЖрдВрд╢рд┐рдХ рдмрд╛рджрд▓",
        en: "Partly Cloudy", 
        or: "рмЖрмВрм╢рм┐рмХ рморнЗрмШрм╛рмЫрмирнНрми"
      },
      'Overcast': {
        hi: "рдмрд╛рджрд▓ рдЫрд╛рдП",
        en: "Overcast", 
        or: "рморнЗрмШрм╛рмЪрнНрмЫрмирнНрми"
      }
    };
    return conditions[condition]?.[currentLanguage] || condition;
  };

  const [filters, setFilters] = useState<FilterState>({
    cropType: "",
    soilType: "",
    season: "",
    irrigation: "",
    fertilizer: "",
    pestDisease: "",
    region: "",
    district: "",
    budget: "",
  });

  const getSelectedCropName = () => {
    if (!filters.cropType || filters.cropType === 'рд╕рднреА' || filters.cropType === 'All' || filters.cropType === 'рм╕рммрнБ') {
      return t.wheat;
    }
    const cropTranslations = {
      'рдЧреЗрд╣реВрдВ': { hi: 'рдЧреЗрд╣реВрдВ', en: 'Wheat', or: 'рмЧрм╣рмо' },
      'Wheat': { hi: 'рдЧреЗрд╣реВрдВ', en: 'Wheat', or: 'рмЧрм╣рмо' },
      'рмЧрм╣рмо': { hi: 'рдЧреЗрд╣реВрдВ', en: 'Wheat', or: 'рмЧрм╣рмо' },
      'рдЪрд╛рд╡рд▓': { hi: 'рдЪрд╛рд╡рд▓', en: 'Rice', or: 'рмзрм╛рми' },
      'Rice': { hi: 'рдЪрд╛рд╡рд▓', en: 'Rice', or: 'рмзрм╛рми' },
      'рмзрм╛рми': { hi: 'рдЪрд╛рд╡рд▓', en: 'Rice', or: 'рмзрм╛рми' },
      'рдЧрдиреНрдирд╛': { hi: 'рдЧрдиреНрдирд╛', en: 'Sugarcane', or: 'рмЖрмЦрнБ' },
      'Sugarcane': { hi: 'рдЧрдиреНрдирд╛', en: 'Sugarcane', or: 'рмЖрмЦрнБ' },
      'рмЖрмЦрнБ': { hi: 'рдЧрдиреНрдирд╛', en: 'Sugarcane', or: 'рмЖрмЦрнБ' },
      'рдордХреНрдХрд╛': { hi: 'рдордХреНрдХрд╛', en: 'Maize', or: 'рмормХрм╛' },
      'Maize': { hi: 'рдордХреНрдХрд╛', en: 'Maize', or: 'рмормХрм╛' },
      'рмормХрм╛': { hi: 'рдордХреНрдХрд╛', en: 'Maize', or: 'рмормХрм╛' },
      'рджрд╛рд▓': { hi: 'рджрд╛рд▓', en: 'Pulses', or: 'рмбрм╛рм▓рм┐' },
      'Pulses': { hi: 'рджрд╛рд▓', en: 'Pulses', or: 'рмбрм╛рм▓рм┐' },
      'рмбрм╛рм▓рм┐': { hi: 'рджрд╛рд▓', en: 'Pulses', or: 'рмбрм╛рм▓рм┐' },
      'рдХрдкрд╛рд╕': { hi: 'рдХрдкрд╛рд╕', en: 'Cotton', or: 'рмХрмкрм╛' },
      'Cotton': { hi: 'рдХрдкрд╛рд╕', en: 'Cotton', or: 'рмХрмкрм╛' },
      'рмХрмкрм╛': { hi: 'рдХрдкрд╛рд╕', en: 'Cotton', or: 'рмХрмкрм╛' },
      'рдЖрд▓реВ': { hi: 'рдЖрд▓реВ', en: 'Potato', or: 'рмЖрм│рнБ' },
      'Potato': { hi: 'рдЖрд▓реВ', en: 'Potato', or: 'рмЖрм│рнБ' },
      'рмЖрм│рнБ': { hi: 'рдЖрд▓реВ', en: 'Potato', or: 'рмЖрм│рнБ' },
      'рдкреНрдпрд╛рдЬ': { hi: 'рдкреНрдпрд╛рдЬ', en: 'Onion', or: 'рмкрм┐рмЖрмЬ' },
      'Onion': { hi: 'рдкреНрдпрд╛рдЬ', en: 'Onion', or: 'рмкрм┐рмЖрмЬ' },
      'рмкрм┐рмЖрмЬ': { hi: 'рдкреНрдпрд╛рдЬ', en: 'Onion', or: 'рмкрм┐рмЖрмЬ' }
    };
    return cropTranslations[filters.cropType]?.[currentLanguage] || filters.cropType;
  };

  const getDynamicPriceLabel = () => {
    const cropName = getSelectedCropName();
    const priceWord = currentLanguage === 'hi' ? 'рднрд╛рд╡' : currentLanguage === 'en' ? 'Price' : 'рмжрм░';
    return `${cropName} ${priceWord}`;
  };

  const handleNewAdvisory = (newAdvisory: AdvisoryResponse) => {
    setAdvisory(newAdvisory);
  };

  const handleFilterChange = (filterType: keyof FilterState, value: string) => {
    setFilters(prev => ({
      ...prev,
      [filterType]: value
    }));
  };

  const handleClearFilters = () => {
    setFilters({
      cropType: "",
      soilType: "",
      season: "",
      irrigation: "",
      fertilizer: "",
      pestDisease: "",
      region: "",
      district: "",
      budget: "",
    });
    setAdvisory(null);
    setDashboardData(null);
    setSoilData(null);
    setMarketData(null);
    setYieldData(null);
  };

  const handleGetAIPrediction = async () => {
    if (!filters.cropType || !filters.region || !filters.district) {
      alert(t.pleaseSelectFilters);
      return;
    }
    setIsAILoading(true);
    try {
      const newAdvisory = await fetchAdvisory(filters);
      setAdvisory(newAdvisory);
      
      setDashboardData({
        expectedYield: newAdvisory.yield_data?.expected_yield || 75,
        yieldTrend: newAdvisory.yield_data?.yield_trend || 'stable',
        soilMoisture: newAdvisory.soil_data?.soil_moisture || 65,
        weather: {
          temperature: newAdvisory.weather_data?.temperature || 28,
          humidity: newAdvisory.weather_data?.humidity || 65,
          precipitation: newAdvisory.weather_data?.precipitation || 12,
          condition: newAdvisory.weather_data?.weather_condition || 'Partly cloudy'
        },
        marketPrice: newAdvisory.market_data?.current_price || 2500,
        priceTrend: newAdvisory.market_data?.price_trend || 'stable'
      });
      
      setSoilData(newAdvisory.soil_data);
      setMarketData(newAdvisory.market_data);
      setYieldData(newAdvisory.yield_data);
    } catch (error) {
      console.error('Failed to fetch AI prediction:', error);
    } finally {
      setIsAILoading(false);
    }
  };

  const handlePhotoUpload = () => {
    const message = currentLanguage === 'hi' ? "рдлреЛрдЯреЛ рдЕрдкрд▓реЛрдб рдлреАрдЪрд░ рдЬрд▓реНрдж рд╣реА рдЖрдПрдЧрд╛!" : 
                   currentLanguage === 'en' ? "Photo upload feature coming soon!" : 
                   "рмлрмЯрнЛ рмЕрмкрм▓рнЛрмб рммрнИрм╢рм┐рм╖рнНрмЯрнНрнЯ рм╢рнАрмШрнНрм░ рмЖрм╕рнБрмЫрм┐!";
    alert(message);
  };

  const menuItems = [
    { id: 'dashboard', label: t.dashboard, icon: icons.chartBar },
    { id: 'prediction', label: t.prediction, icon: icons.trendingUp },
    { id: 'weather', label: t.weather, icon: icons.cloud },
    { id: 'soil', label: t.soil, icon: icons.leaf },
    { id: 'market', label: t.market, icon: icons.dollarSign },
  ];

  return (
    <div className="min-h-screen overflow-x-hidden bg-white">
      <header className="fixed top-0 left-0 right-0 z-50 py-4 text-white shadow-md" style={{ backgroundColor: '#5E936C' }}>
        <div className="max-w-full px-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center flex-1 min-w-0 gap-2">
              <span className="flex-shrink-0 text-2xl">{icons.wheat}</span>
              <div className="min-w-0">
                <h1 className="text-xl font-bold truncate md:text-2xl">{t.title}</h1>
                <p className="text-sm truncate md:text-base" style={{ color: '#E8FFD7' }}>{t.subtitle}</p>
              </div>
            </div>
            <div className="flex items-center flex-shrink-0 gap-4">
              <select 
                className="px-3 py-1 text-sm text-white rounded md:text-base"
                style={{ backgroundColor: '#3E5F44' }}
                value={currentLanguage}
                onChange={(e) => setCurrentLanguage(e.target.value as 'hi' | 'en' | 'or')}
              >
                <option value="hi">рд╣рд┐рдВрджреА</option>
                <option value="en">English</option>
                <option value="or">рмУрмбрм╝рм┐рмЖ</option>
              </select>
            </div>
          </div>
        </div>
      </header>
      <div className="flex pt-20">
        <aside className="fixed bottom-0 left-0 w-48 overflow-y-auto bg-white shadow-lg md:w-64 top-20" style={{ borderRightColor: '#E8FFD7', borderRightWidth: '1px' }}>
          <nav className="p-4">
            {menuItems.map((item) => (
              <button
                key={item.id}
                onClick={() => setActiveSection(item.id)}
                className={`w-full flex items-center gap-3 p-3 rounded-lg mb-2 transition-colors text-sm md:text-base ${
                  activeSection === item.id 
                    ? 'text-white' 
                    : 'hover:bg-gray-100'
                }`}
                style={activeSection === item.id ? { backgroundColor: '#93DA97' } : {}}
              >
                <span className="flex-shrink-0 text-lg">{item.icon}</span>
                <span className="truncate">{item.label}</span>
              </button>
            ))}
          </nav>
        </aside>
        <main className="flex-1 max-w-full p-4 ml-48 overflow-hidden md:ml-64 md:p-6">
          {activeSection === 'dashboard' && (
            <>
              <div className="grid grid-cols-1 gap-4 mb-6 sm:grid-cols-2 lg:grid-cols-4">
                {!dashboardData ? (
                  Array.from({ length: 4 }).map((_, index) => (
                    <div key={index} className="min-w-0 p-4 bg-white border rounded-lg shadow-sm animate-pulse">
                      <div className="flex items-center gap-2 mb-2">
                        <div className="w-5 h-5 bg-gray-200 rounded"></div>
                        <div className="w-20 h-4 bg-gray-200 rounded"></div>
                      </div>
                      <div className="w-16 h-8 mb-1 bg-gray-200 rounded"></div>
                      <div className="w-24 h-3 bg-gray-200 rounded"></div>
                    </div>
                  ))
                ) : (
                  <>
                    <div className="min-w-0 p-4 transition-shadow bg-white border rounded-lg shadow-sm hover:shadow-md" style={{ borderColor: '#E8FFD7' }}>
                      <div className="flex items-center gap-2">
                        <span className="flex-shrink-0 text-lg" style={{ color: '#5E936C' }}>{icons.trendingUp}</span>
                        <span className="text-xs text-gray-600 truncate md:text-sm">{t.expectedYield}</span>
                      </div>
                      <p className="text-xl font-bold md:text-2xl" style={{ color: '#5E936C' }}>
                        {dashboardData.expectedYield}% {dashboardData.yieldTrend === 'increase' ? 'тЖС' : ''}
                      </p>
                      <p className="text-xs text-gray-500 truncate">{t.comparedToLastYear}</p>
                    </div>
                    <div className="min-w-0 p-4 transition-shadow bg-white border rounded-lg shadow-sm hover:shadow-md" style={{ borderColor: '#E8FFD7' }}>
                      <div className="flex items-center gap-2">
                        <span className="flex-shrink-0 text-lg" style={{ color: '#5E936C' }}>{icons.droplets}</span>
                        <span className="text-xs text-gray-600 truncate md:text-sm">{t.soilMoisture}</span>
                      </div>
                      <p className="text-xl font-bold md:text-2xl" style={{ color: '#5E936C' }}>
                        {dashboardData.soilMoisture}%
                      </p>
                      <p className="text-xs text-gray-500 truncate">{t.idealLevel}</p>
                    </div>
                    <div className="min-w-0 p-4 transition-shadow bg-white border rounded-lg shadow-sm hover:shadow-md" style={{ borderColor: '#E8FFD7' }}>
                      <div className="flex items-center gap-2">
                        <span className="flex-shrink-0 text-lg" style={{ color: '#5E936C' }}>{icons.cloud}</span>
                        <span className="text-xs text-gray-600 truncate md:text-sm">{t.todayWeather}</span>
                      </div>
                      <p className="text-xl font-bold md:text-2xl" style={{ color: '#5E936C' }}>
                        {dashboardData.weather.temperature}┬░C
                      </p>
                      <p className="text-xs text-gray-500 truncate">
                        {getWeatherCondition(dashboardData.weather.condition)}
                      </p>
                    </div>
                    <div className="min-w-0 p-4 transition-shadow bg-white border rounded-lg shadow-sm hover:shadow-md" style={{ borderColor: '#E8FFD7' }}>
                      <div className="flex items-center gap-2">
                        <span className="flex-shrink-0 text-lg" style={{ color: '#5E936C' }}>{icons.dollarSign}</span>
                        <span className="text-xs text-gray-600 truncate md:text-sm">{getDynamicPriceLabel()}</span>
                      </div>
                      <p className="text-lg font-bold md:text-2xl" style={{ color: '#5E936C' }}>
                        тВ╣{dashboardData.marketPrice}/{t.quintal}
                      </p>
                      <p className="text-xs text-gray-500 truncate">{t.todayMarketRate}</p>
                    </div>
                  </>
                )}
              </div>
              <div className="p-4 mb-6 overflow-hidden text-white rounded-xl md:p-6" 
                   style={{ background: 'linear-gradient(135deg, #93DA97 0%, #5E936C 100%)' }}>
                <div className="flex items-center gap-3 mb-2">
                  <div className="text-xl md:text-2xl">ЁЯдЦ</div>
                  <h2 className="text-lg font-bold truncate md:text-xl">{t.aiPrediction}</h2>
                </div>
                <p className="mb-4 text-sm md:text-base" style={{ color: '#E8FFD7' }}>{t.aiDescription}</p>
                <div className="flex flex-wrap gap-3">
                  <button 
                    onClick={handleGetAIPrediction}
                    disabled={isAILoading}
                    className="px-4 py-2 text-sm font-semibold transition-colors bg-white rounded-lg md:px-6 hover:bg-gray-100 md:text-base"
                    style={{ color: '#3E5F44' }}
                  >
                    {isAILoading ? (
                      <>
                        <span className="animate-spin inline-block w-4 h-4 border-2 border-t-2 border-gray-300 rounded-full mr-2"></span>
                        {t.loadingAdvice}
                      </>
                    ) : (
                      t.getAI
                    )}
                  </button>
                  <button 
                    onClick={handlePhotoUpload}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-semibold text-white transition-colors rounded-lg md:px-6 hover:opacity-90 md:text-base"
                    style={{ backgroundColor: '#3E5F44' }}
                  >
                    <span>{icons.camera}</span>
                    {t.uploadPhoto}
                  </button>
                </div>
              </div>
              <div className="mb-6">
                <FiltersSection 
                  filters={filters}
                  onFilterChange={handleFilterChange}
                  onClearFilters={handleClearFilters}
                  currentLanguage={currentLanguage}
                />
              </div>
              {!advisory ? (
                <div className="flex items-center justify-center py-12">
                  <div className="w-6 h-6 border-2 border-t-2 border-gray-300 rounded-full md:h-8 md:w-8 animate-spin" 
                       style={{ borderTopColor: '#5E936C' }}></div>
                  <span className="ml-2 text-base md:text-lg">{t.loadingAdvice}</span>
                </div>
              ) : (
                <div className="space-y-4">
                  <AdvisoryCard 
                    advisory={advisory} 
                    onNewAdvisory={handleNewAdvisory}
                    currentLanguage={currentLanguage}
                    filters={filters}
                  />
                </div>
              )}
            </>
          )}
          {activeSection === 'prediction' && (
            <div className="p-6 bg-white border rounded-lg shadow-lg" style={{ borderColor: '#E8FFD7' }}>
              <h2 className="flex items-center gap-2 mb-4 text-xl font-bold">
                <span className="text-2xl" style={{ color: '#5E936C' }}>{icons.trendingUp}</span>
                {t.prediction}
              </h2>
              <div className="grid grid-cols-1 gap-4 mb-6 md:grid-cols-3">
                <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                  <span className="block mb-2 text-2xl" style={{ color: '#5E936C' }}>{icons.target}</span>
                  <h3 className="font-semibold">{t.expectedYield}</h3>
                  <p className="text-2xl font-bold" style={{ color: '#5E936C' }}>
                    {yieldData?.expected_yield || 75}% {yieldData?.yield_trend === 'increase' ? 'тЖС' : ''}
                  </p>
                </div>
                <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                  <span className="block mb-2 text-2xl" style={{ color: '#5E936C' }}>{icons.calendar}</span>
                  <h3 className="font-semibold">{t.bestPlantingTime}</h3>
                  <p className="text-lg font-semibold" style={{ color: '#3E5F44' }}>
                    {yieldData?.best_planting_time}
                  </p>
                </div>
                <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                  <span className="block mb-2 text-2xl" style={{ color: '#5E936C' }}>{icons.droplets}</span>
                  <h3 className="font-semibold">{t.irrigationSchedule}</h3>
                  <p className="text-lg font-semibold" style={{ color: '#3E5F44' }}>
                    {yieldData?.irrigation_schedule}
                  </p>
                </div>
              </div>
              <div className="mt-6">
                <h3 className="mb-3 text-lg font-semibold">ЁЯОп {t.aiSuggestions}:</h3>
                <ul className="space-y-3">
                  {(yieldData?.ai_suggestions || [
                    currentLanguage === 'hi' ? "рдорд┐рдЯреНрдЯреА рдореЗрдВ рдирд╛рдЗрдЯреНрд░реЛрдЬрди рдХреА рдорд╛рддреНрд░рд╛ рдмрдврд╝рд╛рдПрдВ" : 
                    currentLanguage === 'en' ? "Increase nitrogen content in soil" : 
                    "рморм╛рмЯрм┐рм░рнЗ рмирм╛рмЗрмЯрнНрм░рнЛрмЬрнЗрмирм░ рмкрм░рм┐рморм╛рмг рммрмврм╝рм╛рмирнНрмдрнБ"
                  ]).map((rec, index) => (
                    <li key={index} className="flex items-start gap-3 p-3 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                      <span className="text-lg font-bold" style={{ color: '#5E936C' }}>тЬУ</span>
                      <span>{rec}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}
          {activeSection === 'weather' && (
            <div className="grid grid-cols-1 gap-6 lg:grid-cols-2">
              <div className="p-6 bg-white border rounded-lg shadow" style={{ borderColor: '#E8FFD7' }}>
                <h3 className="flex items-center gap-2 mb-4 text-lg font-bold">
                  <span className="text-2xl" style={{ color: '#5E936C' }}>{icons.cloud}</span>
                  {t.weatherDetails}
                </h3>
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.temperature}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {dashboardData?.weather.temperature || 28}┬░C
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.humidity}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {dashboardData?.weather.humidity || 65}%
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.rainfall}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {dashboardData?.weather.precipitation || 12}mm
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.weatherCondition}:</span>
                    <span className="font-bold" style={{ color: '#3E5F44' }}>
                      {getWeatherCondition(dashboardData?.weather.condition || 'Partly cloudy')}
                    </span>
                  </div>
                </div>
              </div>
              <div className="p-6 bg-white border rounded-lg shadow" style={{ borderColor: '#E8FFD7' }}>
                <h3 className="flex items-center gap-2 mb-4 text-lg font-bold">
                  <span className="text-2xl" style={{ color: '#5E936C' }}>{icons.leaf}</span>
                  {t.soilHealthDetails}
                </h3>
                <div className="space-y-4">
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.soilMoisture}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {soilData?.soil_moisture || 65}%
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.phLevel}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {soilData?.ph_level || 6.5}
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.nitrogen}:</span>
                    <span className="font-bold" style={{ color: '#5E936C' }}>
                      {soilData?.nitrogen_level || "medium"}
                    </span>
                  </div>
                  <div className="flex items-center justify-between p-3 rounded" style={{ backgroundColor: '#E8FFD7' }}>
                    <span>{t.phosphorus}:</span>
                    <span className="font-bold" style={{ color: '#3E5F44' }}>
                      {soilData?.phosphorus_level || "medium"}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          )}
          {activeSection === 'soil' && (
            <div className="space-y-6">
              <div className="p-6 bg-white border rounded-lg shadow" style={{ borderColor: '#E8FFD7' }}>
                <h2 className="flex items-center gap-2 mb-4 text-xl font-bold">
                  <span className="text-2xl" style={{ color: '#5E936C' }}>{icons.leaf}</span>
                  {t.soilHealthDetails}
                </h2>
                <div className="grid grid-cols-1 gap-4 mb-6 md:grid-cols-2 lg:grid-cols-4">
                  <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                    <span className="block mb-2 text-2xl" style={{ color: '#5E936C' }}>{icons.droplets}</span>
                    <h3 className="font-semibold">{t.soilMoisture}</h3>
                    <p className="text-2xl font-bold" style={{ color: '#5E936C' }}>
                      {soilData?.soil_moisture || 65}%
                    </p>
                    <div className="w-full h-2 mt-2 bg-gray-200 rounded-full">
                      <div className="h-2 rounded-full" 
                           style={{ 
                             width: `${soilData?.soil_moisture || 65}%`,
                             backgroundColor: '#5E936C'
                           }}></div>
                    </div>
                  </div>
                  <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                    <h3 className="font-semibold">{t.phLevel}</h3>
                    <p className="text-2xl font-bold" style={{ color: '#5E936C' }}>6.5</p>
                    <p className="text-sm text-gray-600">{t.withinNormalRange}</p>
                  </div>
                  <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                    <h3 className="font-semibold">{t.nitrogen}</h3>
                    <p className="text-2xl font-bold" style={{ color: '#5E936C' }}>
                      {soilData?.nitrogen_level || "medium"}
                    </p>
                    <p className="text-sm" style={{ color: '#5E936C' }}>
                      {soilData?.nitrogen_level === "high" ? "85%" : soilData?.nitrogen_level === "medium" ? "65%" : "45%"}
                    </p>
                  </div>
                  <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                    <h3 className="font-semibold">{t.phosphorus}</h3>
                    <p className="text-2xl font-bold" style={{ color: '#3E5F44' }}>
                      {soilData?.phosphorus_level || "medium"}
                    </p>
                    <p className="text-sm" style={{ color: '#3E5F44' }}>
                      {soilData?.phosphorus_level === "high" ? "75%" : soilData?.phosphorus_level === "medium" ? "62%" : "40%"}
                    </p>
                  </div>
                </div>
                <div className="p-4 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                  <h3 className="mb-3 font-semibold">{t.soilImprovementSuggestions}</h3>
                  <ul className="space-y-2">
                    {(soilData?.improvement_suggestions || [
                      t.addDAPFertilizer,
                      t.improveWithOrganic,
                      t.useMulching
                    ]).map((suggestion, index) => (
                      <li key={index} className="flex items-start gap-2">
                        <span style={{ color: '#5E936C' }}>тЬУ</span>
                        <span>{suggestion}</span>
                      </li>
                    ))}
                  </ul>
                </div>
              </div>
            </div>
          )}
          {activeSection === 'market' && (
            <div className="p-6 bg-white border rounded-lg shadow" style={{ borderColor: '#E8FFD7' }}>
              <h3 className="flex items-center gap-2 mb-4 text-lg font-bold">
                <span className="text-2xl" style={{ color: '#5E936C' }}>{icons.dollarSign}</span>
                {t.marketRates}
              </h3>
              <div className="grid grid-cols-1 gap-4 md:grid-cols-2 lg:grid-cols-3">
                {(marketData?.nearby_districts || [
                  { name: "District 1", price: 2450 },
                  { name: "District 2", price: 2550 },
                  { name: "District 3", price: 2400 },
                  { name: "District 4", price: 2600 },
                  { name: "District 5", price: 2500 },
                  { name: "District 6", price: 2480 },
                  { name: "District 7", price: 2680 },
                  { name: "District 8", price: 2610 },
                  { name: "District 9", price: 2310 }
                ]).map((crop, index) => (
                  <div key={index} className="p-4 border-l-4 rounded-lg" 
                       style={{ 
                         backgroundColor: '#E8FFD7',
                         borderLeftColor: '#5E936C'
                       }}>
                    <h4 className="text-lg font-semibold">{crop.name}</h4>
                    <p className="text-2xl font-bold" style={{ color: '#5E936C' }}>
                      тВ╣{crop.price}/{t.quintal}
                    </p>
                    <p className="text-sm" style={{ color: '#5E936C' }}>
                      {marketData?.price_trend === 'increasing' ? 'тЖС' : marketData?.price_trend === 'decreasing' ? 'тЖУ' : 'тЖТ'} {marketData?.price_trend === 'increasing' ? '+2.5%' : marketData?.price_trend === 'decreasing' ? '-1.2%' : '0%'} {marketData?.price_trend === 'increasing' ? t.increase : marketData?.price_trend === 'decreasing' ? t.decrease : t.stable}
                    </p>
                    <p className="mt-2 text-xs text-gray-500">{t.fromLastWeek}</p>
                  </div>
                ))}
              </div>
              <div className="p-4 mt-6 rounded-lg" style={{ backgroundColor: '#E8FFD7' }}>
                <h4 className="mb-3 font-semibold">{t.marketTrends}</h4>
                <ul className="space-y-2 text-sm">
                  {(marketData?.market_trends || [
                    t.oilseedDemand,
                    t.wheatStable,
                    t.cottonVolatile
                  ]).map((trend, index) => (
                    <li key={index}>{trend}</li>
                  ))}
                </ul>
              </div>
            </div>
          )}
        </main>
      </div>
      <button 
        onClick={handlePhotoUpload}
        className="fixed z-40 p-3 text-white transition-colors rounded-full shadow-lg bottom-6 right-6 md:p-4 hover:opacity-90"
        style={{ backgroundColor: '#5E936C' }}
        title={t.uploadPhoto}
      >
        {icons.camera}
      </button>
    </div>
  );
};

export default Index;




















































